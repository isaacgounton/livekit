version: "3.8"

services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - livekit-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  livekit:
    image: livekit/livekit-server:latest
    restart: unless-stopped
    ports:
      - "7880:7880"
      # TURN server ports
      - "3478:3478/udp" # TURN UDP
      - "5349:5349/tcp" # TURN TLS
      # Port range for media relay (adjust as needed)
      - "30000-40000:30000-40000/udp"
    environment:
      LIVEKIT_KEYS: "${LIVEKIT_API_KEY}: ${LIVEKIT_API_SECRET}"
      LIVEKIT_REDIS_ADDRESS: ${REDIS_ADDRESS}
      LIVEKIT_PORT: "7880"
      LIVEKIT_LOGGING_LEVEL: "info"
      # TURN Server Configuration
      LIVEKIT_TURN_ENABLED: "true"
      LIVEKIT_TURN_DOMAIN: "turn.dahopevi.com"
      LIVEKIT_TURN_UDP_PORT: "3478"
      LIVEKIT_TURN_TLS_PORT: "5349"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - livekit-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:7880/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  livekit-network:
    driver: bridge

volumes:
  redis_data:
    driver: local
